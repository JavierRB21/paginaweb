<!-- templates/authentication/dashboard.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}CompostIOT - Dashboard{% endblock %}
{% block dashboard_menu %}
    {% if user.is_authenticated %}
    
    <ul class="navbar-nav" style="display: flex; gap: 15px; list-style: none;">
        <li><a href="{% url 'manage_units' %}"><i class="fas fa-cogs"></i> Unidades</a></li>
        <li><a href="{% url 'statistics' %}"><i class="fas fa-chart-bar"></i> Estad√≠sticas</a></li>
        <li><a href="{% static 'authentication/docs/Documentacion_Tecnica_CompostIoT.pdf' %}" target="_blank"><i class="fas fa-file-pdf"></i> Manual</a></li>
        <li><a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</a></li>
    </ul>
    {% endif %}
{% endblock %}

{% block content %}
<div class="dashboard-container">
<div class="user-info" style="text-align: center;">
    <h3>Bienvenido, {{ user.first_name }} {{ user.last_name }}</h3>
    <p>Usuario: {{ user.username }}</p>
    {% if user.userprofile.organization %}
        <p>Organizaci√≥n: {{ user.userprofile.organization }}</p>
    {% endif %}
</div>
    
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Resumen general -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>{{ user_units.count }}</h3>
            <p>Unidades Totales</p>
        </div>
        <div class="stat-card">
            <h3>{{ active_units }}</h3>
            <p>Unidades Activas</p>
        </div>
        <div class="stat-card">
            <h3>{{ total_capacity|floatformat:0 }} kg</h3>
            <p>Capacidad Total</p>
        </div>
    </div>
    
    <!-- Estado actual de las unidades -->
    {% if recent_data %}
    <div class="current-status">
        <h3>Estado Actual de las Unidades</h3>
        <div class="units-grid">
            {% for item in recent_data %}
            <div class="unit-card">
                <h4>{{ item.unit.name }}</h4>
                <p><strong>Ubicaci√≥n:</strong> {{ item.unit.location }}</p>
                <p><strong>Fase:</strong> <span class="phase-{{ item.phase|lower }}">{{ item.phase }}</span></p>
                <div class="readings">
                    <span class="reading">üå°Ô∏è {{ item.data.temperature|floatformat:1 }}¬∞C</span>
                    <span class="reading">üíß {{ item.data.humidity|floatformat:1 }}%</span>
                    <span class="reading">‚öóÔ∏è pH {{ item.data.ph|floatformat:1 }}</span>
                    <span class="reading">ü´ß O‚ÇÇ {{ item.data.oxygen|floatformat:1 }}%</span>
                </div>
                <small>√öltima lectura: {{ item.data.timestamp|date:"d/m/Y H:i" }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="dashboard-actions">
        <a href="{% url 'manage_units' %}" class="btn btn-primary">Gestionar unidades</a>
        <a href="{% url 'statistics' %}" class="btn btn-secondary">Ver estad√≠sticas</a>
        {% if user_units.count == 0 %}
        <a href="{% url 'create_demo_data' %}" class="btn btn-info">Crear datos de demostraci√≥n</a>
        {% endif %}
        <a href="{% static 'authentication/docs/Documentacion_Tecnica_CompostIoT.pdf' %}" class="btn btn-info" target="_blank">Ver Manual de Usuario</a>
        <a href="{% url 'logout' %}" class="btn btn-danger">Cerrar sesi√≥n</a>
        
    </div>
    <h1 class="titulo-mapa">Ubicaci√≥n</h1>
    <div class="map-container">
    <iframe 
        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15168.056051664915!2d-98.31912089999999!3d18.1171441!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85cf24d5c882f997%3A0x6b4943b5af125952!2sInstituto%20Tecnol%C3%B3gico%20de%20Tecomatl%C3%A1n!5e0!3m2!1ses-419!2smx!4v1763747583286!5m2!1ses-419!2smx" 
        allowfullscreen=""
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade">
    </iframe>
</div>
 
</div>

<style>
.map-container {
    position: relative;
    width: 100%;
    max-width: 200px;
    padding-bottom: 20%; /* Relaci√≥n 16:9 */
    overflow: hidden;
    border-radius: 12px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    margin: 20px auto;
}

.map-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
}
.titulo-mapa {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 15px;
}


.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: linear-gradient(135deg, #2e7d32, #4caf50);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.stat-card h3 {
    font-size: 2em;
    margin: 0;
}

.stat-card p {
    margin: 5px 0 0 0;
    opacity: 0.9;
}

.units-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.unit-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.readings {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px 0;
}

.reading {
    background: #f5f5f5;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.9em;
}

.phase-term√≥fila { color: #f44336; font-weight: bold; }
.phase-mes√≥fila { color: #ff9800; font-weight: bold; }
.phase-enfriamiento { color: #2196f3; font-weight: bold; }
.phase-maduraci√≥n { color: #4caf50; font-weight: bold; }

.current-status {
    margin: 30px 0;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
}
</style>
{% endblock %}
